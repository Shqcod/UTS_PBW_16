<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Todo List</title>
</head>
<body>
  <h1>Todo List</h1>
  <input type="text" id="newTodo" placeholder="Tambah tugas...">
  <button onclick="createTodo()">Tambah</button>
  <ul id="todoList"></ul>
  <button onclick="logout()">Logout</button>

  <script>
    const token = localStorage.getItem('token');

    if (!token) {
      alert('Silakan login terlebih dahulu');
      window.location.href = 'auth.html';
    }

    async function getTodos() {
      const res = await fetch('https://api-todo-list-pbw.vercel.app/todo/getAllTodos', {
        headers: { Authorization: 'Bearer ' + token }
      });
      const data = await res.json();

      const list = document.getElementById('todoList');
      list.innerHTML = '';

      data.data.forEach(todo => {
        const li = document.createElement('li');

        li.innerHTML = `
          <input type="text" id="text-${todo._id}" value="${todo.text}" disabled>
          <button id="btn-${todo._id}" onclick="enableEdit('${todo._id}')">Edit</button>
          <button onclick="markAsDone('${todo._id}', '${todo.text}')">Selesai</button>
          <button onclick="deleteTodo('${todo._id}')">Hapus</button>
        `;
        list.appendChild(li);
      });
    }

    async function createTodo() {
      const text = document.getElementById('newTodo').value;
      if (!text) return alert('Isi todo dulu');

      const res = await fetch('https://api-todo-list-pbw.vercel.app/todo/createTodo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ text })
      });

      await res.json();
      document.getElementById('newTodo').value = '';
      getTodos();
    }

    

    async function deleteTodo(id) {
      await fetch(`https://api-todo-list-pbw.vercel.app/todo/deleteTodo/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      getTodos();
    }

    async function markAsDone(id, text) {
      const res = await fetch(`https://api-todo-list-pbw.vercel.app/todo/updateTodo/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          text: text,
          onCheckList: true
        })
      });

      if (res.ok) {
        alert("Tugas selesai!");
        getTodos();
      } else {
        alert("Gagal menandai tugas sebagai selesai.");
      }
    }

    function enableEdit(id) {
      const textInput = document.getElementById(`text-${id}`);
      const button = document.getElementById(`btn-${id}`);

      if (button.textContent === 'Edit') {
        textInput.disabled = false;
        textInput.focus();
        button.textContent = 'Simpan';
      } else {
        const newText = textInput.value;

        // Tahap 1: izinkan edit dengan paksa checklist = true
        fetch(`https://api-todo-list-pbw.vercel.app/todo/updateTodo/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            text: newText,
            onCheckList: true
          })
        }).then(() => {
          // Tahap 2: langsung ubah status jadi false lagi
          return fetch(`https://api-todo-list-pbw.vercel.app/todo/updateTodo/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              text: newText,
              onCheckList: false
            })
          });
        }).then(() => {
          textInput.disabled = true;
          button.textContent = 'Edit';
          getTodos();
        });
      }
    }
    
    function logout() {
      const userId = localStorage.getItem('userId');
      fetch(`https://api-todo-list-pbw.vercel.app/auth/logout/${userId}`, {
        method: 'POST'
      }).then(() => {
        localStorage.clear();
        alert('Berhasil logout');
        window.location.href = 'auth.html';
      });
    }

    getTodos();
  </script>
</body>
</html>
